name: Seed roadmap issues

on:
  workflow_dispatch:
    inputs:
      seed_file:
        description: "Path to seed file"
        required: true
        default: "roadmap/issues.yml"

permissions:
  contents: read
  issues: write

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Create milestones (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SEED: ${{ inputs.seed_file }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          count=$(yq '.milestones | length' "$SEED")
          for i in $(seq 0 $((count-1))); do
            title=$(yq -r ".milestones[$i].title" "$SEED")
            desc=$(yq -r ".milestones[$i].description" "$SEED")

            # Check if milestone exists (paginate to handle >100 milestones)
            exists=$(gh api -X GET "repos/$REPO/milestones?state=all" --paginate --jq ".[] | select(.title==\"$title\") | .number" | head -n 1 || true)
            if [ -z "$exists" ]; then
              echo "Creating milestone: $title"
              gh api -X POST "repos/$REPO/milestones" -f title="$title" -f description="$desc" >/dev/null
            else
              echo "Milestone \"$title\" already exists. Skipping."
            fi
          done

      - name: Create issues (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SEED: ${{ inputs.seed_file }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Build a milestone title->number map
          gh api "repos/$REPO/milestones?state=all&per_page=100" > /tmp/milestones.json

          issues_count=$(yq '.issues | length' "$SEED")
          for i in $(seq 0 $((issues_count-1))); do
            title=$(yq -r ".issues[$i].title" "$SEED")
            milestone_title=$(yq -r ".issues[$i].milestone" "$SEED")
            body=$(yq -r ".issues[$i].body" "$SEED")

            # labels as JSON array
            labels_json=$(yq -o=json ".issues[$i].labels" "$SEED")

            milestone_number=$(
            python - "$milestone_title" <<'PY'
            import json, sys
            ms = json.load(open("/tmp/milestones.json"))
            mt = sys.argv[1]
            for m in ms:
                if m["title"]==mt:
                    print(m["number"])
                    break
            else:
                print("")  # Prints empty string if not found
            PY
            )

            # Skip if issue with exact title exists
            existing=$(gh issue list -R "$REPO" --search "\"$title\" in:title" --json title,number --jq ".[] | select(.title==\"$title\") | .number" | head -n 1 || true)
            if [ -n "${existing:-}" ]; then
              echo "Issue exists: \"$title\" (#$existing) â€” skipping"
              continue
            fi

            echo "Creating issue: \"$title\""
            # Create issue
            number=$(gh api -X POST "repos/$REPO/issues" \
              -f title="$title" \
              -f body="$body" \
              -F milestone=$milestone_number \
              --jq '.number')

            # Apply labels (separate call; robust)
            echo "{\"labels\": $labels_json}" > /tmp/labels.json
            gh api -X POST "repos/$REPO/issues/$number/labels" --input /tmp/labels.json >/dev/null
          done

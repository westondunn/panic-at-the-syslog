name: panic-at-the-syslog

x-python-service: &python-service
  image: python:3.12-slim
  working_dir: /workspace
  volumes:
    - ../../:/workspace
  environment:
    - PYTHONPATH=/workspace
    - PIP_DISABLE_PIP_VERSION_CHECK=1
  restart: unless-stopped

services:
  kafka:
    image: bitnamilegacy/kafka:3.7
    restart: unless-stopped
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
    healthcheck:
      test: ["CMD-SHELL", "/opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    ports:
      - "9092:9092"
    volumes:
      - kafka_data:/bitnami/kafka

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=panic
      - POSTGRES_USER=panic
      - POSTGRES_PASSWORD=panic
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U panic -d panic"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    command: ["serve"]
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  ingress:
    <<: *python-service
    command:
      - /bin/sh
      - -c
      - pip install --no-cache-dir -r requirements-dev.txt && python -m services.ingress
    environment:
      - PYTHONPATH=/workspace
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - INGRESS_LISTEN_PORT_UDP=514
      - INGRESS_LISTEN_PORT_TCP=514
      - INGRESS_SPOOL_ENABLED=true
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "1514:514/udp"
      - "1514:514/tcp"
    volumes:
      - ../../:/workspace
      - ingress_spool:/var/spool/panic-ingress

  normalizer:
    <<: *python-service
    command:
      - /bin/sh
      - -c
      - pip install --no-cache-dir -r requirements-dev.txt && python -c "import time; from services.normalizer.app import NormalizerService; print(NormalizerService().health()); time.sleep(360000)"
    depends_on:
      kafka:
        condition: service_healthy

  detector:
    <<: *python-service
    command:
      - /bin/sh
      - -c
      - pip install --no-cache-dir -r requirements-dev.txt && python -c "import time; from services.detector.app import DetectorService; print(DetectorService().health()); time.sleep(360000)"
    depends_on:
      kafka:
        condition: service_healthy

  analyzer:
    <<: *python-service
    command:
      - /bin/sh
      - -c
      - pip install --no-cache-dir -r requirements-dev.txt && python -c "import time; from services.analyzer.app import AnalyzerService; print(AnalyzerService().health()); time.sleep(360000)"
    environment:
      - PYTHONPATH=/workspace
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - OLLAMA_BASE_URL=http://ollama:11434
    depends_on:
      kafka:
        condition: service_healthy
      ollama:
        condition: service_started

  api:
    <<: *python-service
    command:
      - /bin/sh
      - -c
      - pip install --no-cache-dir -r requirements-dev.txt && uvicorn services.api.app:create_app --factory --host 0.0.0.0 --port 8000
    environment:
      - PYTHONPATH=/workspace
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - PANIC_JWT_SECRET=
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/healthz')\""]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8000:8000"

  ui:
    image: node:20-alpine
    working_dir: /workspace/services/ui
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - npm ci && npm run dev -- --hostname 0.0.0.0 --port 3000
    environment:
      - API_BASE_URL=http://api:8000
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "3000:3000"
    volumes:
      - ../../:/workspace

volumes:
  kafka_data:
  postgres_data:
  ollama_data:
  ingress_spool:
